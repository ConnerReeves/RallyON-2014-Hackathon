<!DOCTYPE html>
<html>
<head>
    <title>RallyON 2014 Hackathon</title>

    <script type="text/javascript" src="/apps/2.0rc3/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',

    activeFeatureIndex : 0,
    selectedFeatures   : [],

    layout: 'border',
    launch: function() {
        //Reload process
        Deft.Chain.pipeline([
            function() {
                this.add([{
                    region: 'north',
                    minWidth: 300,
                    layout: 'hbox',
                    items: [{
                        xtype: 'button',
                        cls: 'icon-btn',
                        height: 29,
                        width: 41,
                        margin: '2 2 2 2',
                        text: '<span class="icon-chevron-left icon-large"></span>',
                        handler: function() {
                            this.activeFeatureIndex--;
                            this._updateActiveFeature();
                        },
                        scope: this
                    },{
                        xtype: 'button',
                        cls: 'icon-btn',
                        height: 29,
                        width: 41,
                        margin: '2 2 2 2',
                        text: '<span class="icon-chevron-right icon-large"></span>',
                        handler: function() {
                            this.activeFeatureIndex++;
                            this._updateActiveFeature();
                        },
                        scope: this
                    },{
                        xtype: 'container',
                        id: 'activeFeatureInfoContainer',
                        margin: '0 0 0 10',
                        html: '<span class="icon-spinner icon-large icon-spin"></span>'
                    },{
                        xtype: 'component',
                        flex: 1
                    },{
                        xtype: 'button',
                        cls: 'icon-btn',
                        height: 29,
                        width: 41,
                        margin: '2 2 2 2',
                        text: '<span class="icon-gear icon-large"></span>',
                        arrowCls: '',
                        menu: {
                            xtype: 'menu',
                            plain: true,
                            items: [{
                                text: '<span class="icon-plus icon-large"></span> Add Features',
                                handler: function() {
                                    Ext.create('Rally.ui.dialog.ChooserDialog', {
                                        title               : 'Choose Features to Add', 
                                        selectionButtonText : 'Save',
                                        artifactTypes       : ['portfolioItem/Feature'],
                                        autoShow            : true,
                                        multiple            : true,
                                        model               : true,
                                        height              : 510,
                                        width               : 700,
                                        movable             : true,
                                        columns             : [{
                                            dataIndex : 'FormattedID',
                                            maxWidth  : 65
                                        },{
                                            dataIndex : 'Name',
                                            flex      : 1
                                        }],
                                        storeConfig : {
                                            pageSize : 20000,
                                            sorters: [{
                                                property  : 'FormattedID',
                                                direction : 'ASC'
                                            }]
                                        },
                                        gridConfig: {
                                            showPagingToolbar : false,
                                            margin            : '5 0 11 0',
                                            style             : {
                                                borderBottom: '2px solid #888888'
                                            }
                                        },
                                        listeners: {
                                            artifactChosen: function(records) {
                                                if (records.length > 0) {
                                                    this.selectedFeatures = _.sortBy(_.values(_.indexBy(this.selectedFeatures.concat(_.pluck(records, 'data')), function(data) {
                                                        return data.ObjectID;
                                                    })), 'FormattedID');

                                                    this._saveSelectedFeatures();
                                                    this._updateActiveFeature();
                                                } else {
                                                    Ext.Msg.alert('Error', 'No Features chosen.');
                                                }
                                            },
                                            scope: this
                                        }
                                    });
                                },
                                scope: this
                            },{
                                text: '<span class="icon-minus icon-large"></span> Remove Features',
                                handler: function() {
                                    Ext.create('Rally.ui.dialog.ChooserDialog', {
                                        title               : 'Choose Features to Remove', 
                                        selectionButtonText : 'Save',
                                        artifactTypes       : ['portfolioItem/Feature'],
                                        autoShow            : true,
                                        multiple            : true,
                                        model               : true,
                                        height              : 510,
                                        width               : 700,
                                        movable             : true,
                                        columns             : [{
                                            dataIndex : 'FormattedID',
                                            maxWidth  : 65
                                        },{
                                            dataIndex : 'Name',
                                            flex      : 1
                                        }],
                                        storeConfig : {
                                            pageSize : 20000,
                                            sorters: [{
                                                property  : 'FormattedID',
                                                direction : 'ASC'
                                            }],
                                            filters : Rally.data.QueryFilter.or(_.map(this.selectedFeatures, function(data) {
                                                return {
                                                    property : 'ObjectID',
                                                    value    : data.ObjectID
                                                };
                                            }))
                                        },
                                        gridConfig: {
                                            showPagingToolbar : false,
                                            margin            : '5 0 11 0',
                                            style             : {
                                                borderBottom: '2px solid #888888'
                                            }
                                        },
                                        listeners: {
                                            artifactChosen: function(records) {
                                                if (records.length > 0) {
                                                    var OIDsToRemove = _.map(records, function(record) {
                                                        return record.get('ObjectID');
                                                    });

                                                    this.selectedFeatures = _.sortBy(_.filter(this.selectedFeatures, function(data) {
                                                        return !_.contains(OIDsToRemove, data.ObjectID);
                                                    }), 'FormattedID');

                                                    this._saveSelectedFeatures();
                                                    this._updateActiveFeature();
                                                } else {
                                                    Ext.Msg.alert('Error', 'No Features chosen.');
                                                }
                                            },
                                            scope: this
                                        }
                                    });
                                },
                                scope: this                   
                            }]
                        }
                    }]
                },{
                    region : 'center',
                    layout : 'border',
                    border : false,
                    items  : [{
                        region : 'north',
                        layout : 'hbox',
                        height : 450,
                        items  : [{
                            xtype  : 'container',
                            id     : 'gridContainer',
                            flex   : 1,
                            style  : {
                                borderRight: '1px solid #D6D6D6'
                            },
                            items: [{
                                xtype             : 'rallygrid',
                                id                : 'rallygrid',
                                showPagingToolbar : false,
                                height            : 450,
                                features          : [{
                                    ftype          : 'groupingsummary',
                                    groupHeaderTpl : '{name} ({rows.length} User Stor{[values.rows.length > 1 ? "ies" : "y"]})',
                                    collapsible    : false
                                }],
                                storeConfig       : {
                                    model    : 'UserStory',
                                    pageSize : 20000,
                                    filters  : [{
                                        property : 'ObjectID',
                                        value    : -1
                                    }]
                                },
                                columnCfgs: [{
                                    dataIndex : 'FormattedID',
                                    width     : 70
                                }, 'Name', {
                                    dataIndex : 'ScheduleState',
                                    align     : 'center',
                                    width     : 70
                                },{
                                    dataIndex : 'PlanEstimate',
                                    align     : 'center',
                                    width     : 60,
                                    renderer  : function(val, meta, record) {
                                        return Math.round(val * 100) / 100;
                                    }
                                }]
                            }]
                        },{
                            xtype : 'container',
                            id    : 'radialContainer',
                            flex  : 1,
                            html  : 'Radial goes here...'
                        }]
                    },{
                        region: 'center',
                        html: 'Charts go here...'
                    }]
                }]);
            },

            function() {
                var deferred = Ext.create('Deft.Deferred');
                Rally.data.PreferenceManager.load({
                    filterByUser: true,
                    success: function(prefs) {
                        deferred.resolve(Ext.JSON.decode(prefs.selectedFeatureOIDs));
                    },
                    scope: this
                });
                return deferred.promise;
            },

            function(featureOIDs) {
                if (featureOIDs && featureOIDs.length > 0) {
                    var deferred = Ext.create('Deft.Deferred');
                    Ext.create('Rally.data.WsapiDataStore', {
                        limit   : Infinity,
                        model   : 'portfolioItem/Feature',
                        fetch   : ['ObjectID','FormattedID','Name'],
                        filters : Rally.data.QueryFilter.or(_.map(featureOIDs, function(OID) {
                            return {
                                property : 'ObjectID',
                                value    : OID
                            };
                        })),
                        sorters : [{
                            property  : 'FormattedID',
                            direction : 'ASC'
                        }]
                    }).load({
                        callback: function(records, operation, success) {
                            this.selectedFeatures = _.pluck(records, 'data');
                            this._updateActiveFeature();
                            deferred.resolve();
                        },
                        scope: this
                    });
                    return deferred.promise;
                } else {
                    Ext.getCmp('activeFeatureInfoContainer').update('Add Features...');
                }
            }
        ], this);
    },

    _updateActiveFeature: function() {
        if (this.activeFeatureUpdateProcess && this.activeFeatureUpdateProcess.getState() === 'pending') this.activeFeatureUpdateProcess.cancel();

        this.activeFeatureData = this.selectedFeatures[Math.abs(this.activeFeatureIndex) % this.selectedFeatures.length];

        //Reinitialize UI components
        Ext.getCmp('rallygrid').store.removeAll();
        
        if (this.activeFeatureData) {
            this.activeFeatureUpdateProcess = Deft.Chain.pipeline([
                //Update UI components
                function() {
                    Ext.getCmp('rallygrid').setLoading(true);
                    Ext.getCmp('activeFeatureInfoContainer').update(Ext.String.format('{0}: {1}', this.activeFeatureData.FormattedID, this.activeFeatureData.Name));
                },

                function() {
                    var deferred = Ext.create('Deft.Deferred');
                    Ext.create('Rally.data.WsapiDataStore', {
                        limit   : Infinity,
                        model   : 'UserStory',
                        fetch   : [
                            'FormattedID',
                            'Iteration',
                            'Name',
                            'PlanEstimate',
                            'ScheduleState',
                            'Project'
                        ],
                        filters    : [{
                            property : 'Feature.ObjectID',
                            value    : this.activeFeatureData.ObjectID
                        },{
                            property : 'DirectChildrenCount',
                            value    : 0
                        }],
                        groupField: 'Project',
                        getGroupString: function(record) {
                            return record.get('Project').Name;
                        }
                    }).load({
                        callback : function(records, operation, success) {
                            deferred.resolve(this);
                        }
                    });
                    return deferred.promise;
                }
            ], this);

            this.activeFeatureUpdateProcess.then({
                success: function(store) {
                    //Update Grid
                    Ext.getCmp('rallygrid').bindStore(store);
                },
                scope: this
            }).always(function() {
                Ext.getCmp('rallygrid').setLoading(false);
            });
        } else {
            Ext.getCmp('activeFeatureInfoContainer').update('Add Features...');
            Ext.getCmp('rallygrid').setLoading(false);
        }
    },

    _saveSelectedFeatures: function() {
        Rally.data.PreferenceManager.update({
            filterByUser: true,
            settings: {
                activeFeatureIndex  : this.activeFeatureIndex,
                selectedFeatureOIDs : Ext.JSON.encode(_.map(this.selectedFeatures, function(data) {
                    return data.ObjectID;
                }))
            },
            success: function() {
                Rally.ui.notify.Notifier.show({
                    message  : 'Settings saved successfully.',
                    duration : 2500
                });
            }
        });
    },

    _updateTrendCharts: function(iterationName) {
        if (this.trendChartUpdateProcess && this.trendChartUpdateProcess.getState() === 'pending') this.trendChartUpdateProcess.cancel();

        this.trendChartUpdateProcess = Deft.Chain.pipeline([
            //Get the iteration OIDs to filter by
            function() {
                var deferred = Ext.create('Deft.Deferred');
                
                var projectNameFilters = _.map(Ext.getCmp('rallygrid').store.groups.keys, function(groupName) {
                    return {
                        property : 'Project.Name',
                        value    : groupName
                    };
                });

                Ext.create('Rally.data.WsapiDataStore', {
                    limit   : Infinity,
                    model   : 'Iteration',
                    fetch   : ['ObjectID','StartDate','EndDate'],
                    filters : [{
                        property : 'Name',
                        value    : iterationName
                    },{
                        property : 'StartDate',
                        operator : '!=',
                        value    : null
                    },{
                        property : 'EndDate',
                        operator : '!=',
                        value    : null
                    }, Rally.data.QueryFilter.or(projectNameFilters)]
                }).load({
                    callback : function(records, operation, success) {
                        var data = _.pluck(records, 'data');

                        var queryDate  = _.min(_.pluck(data, 'StartDate'));
                        var maxDate    = _.max(_.pluck(data, 'EndDate'));
                        var queryDates = [];

                        while (queryDate <= maxDate) {
                            queryDates.push(queryDate);
                            queryDate = Ext.Date.add(queryDate, Ext.Date.DAY, 1);
                        }

                        deferred.resolve({
                            OIDs       : _.pluck(data, 'ObjectID'),
                            queryDates : queryDates
                        });
                    }
                });
                return deferred.promise;
            },

            function(iterationConfig) {
                var deferred = Ext.create('Deft.Deferred');
                
                Deft.Promise.all(_.map(iterationConfig.queryDates, function(queryDate) {
                    return function() {
                        var deferred = Ext.create('Deft.Deferred');
                        Ext.create('Rally.data.lookback.SnapshotStore', {
                            autoLoad: true,
                            listeners: {
                                load: function(store, data, success) {
                                    debugger;
                                }
                            },
                            fetch: ['Name', 'ScheduleState'],
                            find: [
                                {
                                    property: '_TypeHierarchy',
                                    operator: 'in',
                                    value: ['Defect', 'HierarchicalRequirement']
                                }
                            ]
                        });
                        // Ext.create('Rally.data.lookback.SnapshotStore', {
                        //     limit   : Infinity,
                        //     fetch   : ['Name'],
                        //     filters : [{
                        //         property : '__At',
                        //         value    : Rally.util.DateTime.toIsoString(queryDate)
                        //     },{
                        //         property : '_TypeHierarchy',
                        //         value    : 'HierarchicalRequirement'
                        //     },{
                        //         property : 'Children',
                        //         value    : null
                        //     },{
                        //         property : 'Iteration',
                        //         operator : 'in',
                        //         value    : iterationConfig.OIDs
                        //     }]
                        // }).load({
                        //     params : {
                        //         compress                    : true,
                        //         removeUnauthorizedSnapshots : true
                        //     },
                        //     callback : function(records, operation, success) {
                        //         deferred.resolve(records);
                        //     }
                        // });
                        return deferred.promise;
                    }();
                })).then({
                    success: function(out) {
                        console.log(out);
                    }
                });

                return deferred.promise;
            }
        ], this);
    }
});

            Rally.launchApp('CustomApp', {
                name:"RallyON 2014 Hackathon",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
  overflow: hidden !important;
}
.icon-btn .x-btn-inner {
  padding: 0 !important;
  font-size: 17px !important;
}
.x-btn-default-small {
  background-color: #00A9E0;
}
#activeFeatureInfoContainer {
  line-height: 34px;
  color: #666;
  font-size: 14px;
  font-weight: bold;
  font-style: italic;
}
.x-column-header-sort-ASC,
.x-column-header-sort-DESC {
  background: transparent !important;
}
.x-grid-group-title {
  color: #666;
}
.x-grid-group-hd {
  border-color: #888;
}
.x-grid-row-summary {
  display: none;
}

    </style>
</head>
<body></body>
</html>
